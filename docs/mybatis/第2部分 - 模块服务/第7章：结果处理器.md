# 将sql语句执行的结果进行映射返回

## 一、前言

之前的查询都是耦合在了sqlsession中了。 一旦要进行扩展修改就必须改动这个sqlsession了。 为了降低耦合所以必须将执行sql这个逻辑给拆分出去。这时候很多人就会想到设计模式，例如模版、策略等设计模式，很多的源码中也都频繁的使用这两种设计模式，可以说学会这两种设计模式可以看懂很多代码

## 二、目标

降低代码耦合度，尽量不改动原代码，只是新增实现类替换掉，对于此类SQL的执行就必须抽象出来一套标准。

## 三、设计



![图 7-3 SQL方法执行器核心类关系](/mybatis/2/image.png)
## 四、实现

```java:line-numbers {1}
├── executor
│   ├── resultset
│   │   ├── DefaultResultSetHandler.java
│   │   └── ResultSetHandler.java
│   ├── statement
│   │   ├── BaseStatementHandler.java
│   │   ├── PreparedStatementHandler.java
│   │   ├── SimpleStatementHandler.java
│   │   └── StatementHandler.java
│   ├── BaseExecutor.java
│   ├── Executor.java
│   └── SimpleExecutor.java
```



## 五、总结

在BaseStatementHandler中定义结果集，将sql处理后的内容使用结果集进行处理，得到映射bean的语句，这个映射的Class对象是在xml中设置的例如：

```xml:line-numbers {1}
<select id="queryUserInfoById" parameterType="java.lang.Long" resultType="cn.bugstack.mybatis.test.po.User">
    SELECT id, userId, userName, userHead
    FROM user
    where id = #{id}
</select>
```

如上就是一个标准的mybatis的一个xml中的一个sql语句，将sql语句进行执行后，获取到的结果在new cn.bugstack.mybatis.test.po.User这个对象，进行set进去，这个操作就是在结果集类中进行处理的

伪代码如下：（在github中可以看到完整代码）

```java:line-numbers {1}
public class DefaultResultSetHandler {
    private String ResultType; 
	 //方法接受传入的执行结果
    public <E> List<E> handleResultSets(Statement stmt){
     		//获取sql的执行结果
        ResultSet resultSet = stmt.getResultSet();
        try {
          //将执行结果进行返回
            return resultSet2Obj(resultSet,ResultType);
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
            return null;
        }
    }
  	private <T> List<T> resultSet2Obj(ResultSet resultSet,String clazz) {
      //new 一个clazz
      //将resultSet中的结果set进这个clazz中
    }
}
```

## 六、结果

可以看到运行结果都是正确的，并且已经成功创建了一个User的类进行赋值

```java:line-numbers {1}
static void extracted2(Connection connection) throws SQLException {
    Statement statement = connection.prepareStatement("SELECT id,name,age\n" +
            "        FROM user\n" +
            "        where id = ?");
    statement.setQueryTimeout(350);
    statement.setFetchSize(10000);
    PreparedStatement ps = (PreparedStatement) statement;
    ps.setLong(1, 1);
    boolean execute = ps.execute();
    System.out.println(execute);
    BoundSql boundSql = new BoundSql(null, null, null, "com.nbsb.mybatis.test.po.User");
    DefaultResultSetHandler defaultResultSetHandler = new DefaultResultSetHandler(boundSql);
    List<Object> objects = defaultResultSetHandler.handleResultSets(ps);
    System.out.println(objects);
}
```

```
15:16:44.126 [main] INFO  c.alibaba.druid.pool.DruidDataSource - {dataSource-1} inited
true
[User{id=1, name='whn', age=108}]
```

